<!DOCTYPE html>
<html>
    <head>
        <title>Java Script Loan Calculator
            <style>
                                        /* Таблица стилей CSS: определяет внешний вид программы*/
.output {font-weight: bold; }           /* Жирный шрифт для вычесленных значений */
#payment {text-decoration: underline;}  /* Для элементов с id= "payment"*/
#graph {border: solid black 1px;}     /* Простая рамка для диаграммы */
th, td { vertical-align: top;}         /* Выравнивание в ячейках */
            </style> 
        </title>
    </head>
    <body>
        <!-- Это HTML- таблица с элементами <input>, позволяющая вводить данные, и с элементами <span>, в которых отображаются результаты вычислений. Эти элементы имеют идентификаторы, такие как "interest" и "years". Данные идентификаторы используются в JavaScript-коде, который следует за опрделением таблицы. Обратите внимание, что для некоторых элементов ввода определены обработчики событий "onchange" и "onclick". В них заданы строки JavaScript-коды, выполняемого при вводе данных или щелчке на кнопке.
             -->
             <table>
                 <tr><th>Enter Loan Data:</th>
                    <td></td>>
                <th>Loan Balance, Cumulative Equity, and Interest Payments</th></tr>
                <tr><td>Amount of the loan ($):</td>
                <td><input id="amount" onchange="calculate();"></td>
            <td respawn=8>
                <canvas id="graph" width="400" height="250"></canvas></td></tr>
                <tr><td>Annual interest (%):</td>
                    <td><input id="apr" onchange="calculate()" ;></td></tr>
                    <tr><td>Repayment period (years):</td>
                <td><input id="years" onchange="calculate()";></td>
                    <tr><td>Zipcode (to find lenders)</td>
                <td><input id="zipcode" onchange="calculate()";></td>
                    <tr><th>Approximate Payments:</th>
                        <td><button onclick="calculate();">Calculate</button></td></tr>
                    <tr><td>Monthly Payments:</td>
                        <td>$<span class="output" id="payment"></span></td></tr>
                    <tr><td>Total payment:</td>
                        <td>$<span class="output" id="total"></span></td></tr> 
                    <tr><td>Total interest:</td>
                        <td>$<span class="output" id="totalinterest"></span></td></tr>
                    <tr><th>Sponsors:</th><td colspan="2">
                            Apply for your loan with one of these fine lenders:
                            <div id="lenders"></div></td></tr>  
             </table>
<!-- Остальная часть примера - JavaScript-код в теге <script> ниже. Обычно сценарии помещаются в начало документа, в заголовк <head>? но в данном случае вам проще будет понять пример, если JavaScript-код будет находиться ниже HTML-содержимого.-->
<script>
    "use strict"; // Использовать строгий режим ECMAScript 5, если броузер поддерживает его
    /*
        Этот сценарий определяет функцию calculate(), вызываемую обработчиками событий в разметке HTML выше. Функция читает значение изи элемента <input>, вычисляет размеры платежей по ссуде, отображает результаты в элементах <span>. Кроме того, она сохраняет пользовательские данные, отображает ссылки на кредитные учреждения и рисует диаграмму. */
function calculate() {
    //Отыскать элементы ввода и вывода в документн
  var amount = document.getElementById("amount");
  var apr = document.getElementById("apr");
  var years = document.getElementById("years");
  var zipcode = document.getElementById("zipcode");
  var payment = document.getElementById("payment");
  var total = document.getElementById("total");
  var totalinterest = document.getElementById("totalinterest");

  //Получить ввод получить ввод пользователья из элементов ввода. Предполагается что все данные являются корректными. Преобразовать процентную ставку из процентов в десятичное число и преобразовать годовую ставку в месячную ставку. Преобразовать период платежей в годах в количество месячных платажей.//
  var principal = parseFloat(amount.value);
  var interest = parseFloat(apr.value) / 100 / 12;
  var payments  = parseFloat(years.value) * 12;

  //Теперь вычислить сумму ежемесячного платежа
  var x = Math.pow(1 + interest.payments); // Math.pow() вычисляет степень
  var monthly = (principal * x * interest)/(x-1);

  //Если результатом является конечное число, следовательно, пользователь указал корректные данные и результат можно отобразить 
  if (isFinite(monthly)) {
      //Заполнить поля вывода, округлив результаты до 2 десятичных знаков
      payment.innerHTML = monthly.toFixed(2);
      total.innerHTML = (monthly * payments).toFixed(2);
      totalinterest.innerHTML = ((monthly * payments) - principal).toFixed(2);

      // Сохранить ввод пользователя, чтобы можно было восстановить данных при следующем открыитие станицы
      save(anount.value, apr.value, years.value, zipcode.value);
      
      //Реклама: отыскать и отобразить ссылки на сайты местных кредитных учреждений, но игнорировать сетевые ошибки
      try {   //Перехватывать все ошибки, возникающие в этих фигурных скобках
            getLenders(amount.value, apr.value, years.value, zipcode.value);
      }
        catch(e) { /*и игнорировать эти ошибки*/}
      //В заключении вывести график изменения остатка по кредиту, а также графики сумм, выплачиваемых в погашение кредита и по процентам
      chart(principal, interest, monthly, payments);   
    }
        else {
            //Результат не является числом или имеет бесконечное значение, что означает, что были получены неполные или некорректные данные. 
            //Очистить все результаты введеные ранее.
            payment.innerHTML = ""; //Стереть содержимое этих элементов
            total.innerHTML = "";
            totalinterest.innerHTML = "";
            chart();        //При вызове без аргументов очищает диаграмму
        }
}
//Сохранить ввод пользователя в свойствах объекта localStorage. Значение этих свойств будут доступны при повторном посещение страницы. В некоторых браузерах ( например, в Firefox) возможность сохранения не поддерживается, если страница открывается с адресом URL вида file://. Однако она поддерживается при открытии страницы через HTTP.
function save(amount, apr, years, zipcode) {
    if (window.localStorage) { //выполняется сохранение, если поддерживается
        localStorage.loan_amount = amount;
        localStorage.loan_apr = apr;
        localStorage.loan_years = years;
        localStorage.loan_zipcode = zipcode;
    }
}
//Автоматически восстановить поля ввода при загрузке документа.
window.onload = function() {
    //Если броузер поддерживает localStorage и имеются сохраненные данные
    if (window.localStorage && localStorage.loan_amount) {
        document.getElementById("amount").value = localStorage.loan_amount;
        document.getElementById("apr").value = localStorage.loan_apr;
        document.getElementById("years").value = localStorage.loan_years;
        document.getElementById("zipcode").value = localStorage.loan_zipcode;
    }
};
//Передать ввод пользователю серверному сценарию, который может (теоретически) возвращать список ссылок на сайты местных кредитных учереждений, готовых предоставить кредит, Данный пример не включает фактическую реализацию такого сценария поиска кредитных учреждений. Но если такой сценарий уже имеется, данная функция могла бы работать с ним.
function getLanders(amount, apr, years, zipcode)    {
    //Если броузер не поддерживает объект XMLHttpRequest, не делать ничего.
    if (!window.XMLHttpRequest) return;

    //Отыскать элемент для отображения списка кредитных организаций
    var ad = document.getElementById("lenders");
    if (!ad) return;                                //Выйти, если элемент отсутствует
    //Преобразовать ввод пользователя в параметры запроса в строке URL
    var url = "getLenders.php" +                    //Адрес URL службы плюс
          "?amt=" +encodeURIComponent(amount) +     //данные пользователя
          "&apr=" +encodeURIComponent(apr) +        //в строке запроса
          "&yrs=" +encodeURIComponent(years) +
          "&zip=" +encodeURIComponent(zipcode);
          //Получить сожердимое по заданному адресу URL с помощью XMLHttpRequest
    var req = new XMLHttpRequest();                 //Создать новый запрос
    req.open("Get", url);                           //Указать тип запроса HTTP GET для URL
    req.sen(null);                                  //Отправит запрос без тела

    // Перед возвратом зарегистрировать обработчик события, который будет вызываться при получении HTTP-ответа от сервера. Такой прием асинхронного программирования является довольно обычным в клиентском JavaScript.
    req.onreadystatechange = function() {
        if (req.readyState == 4 && req.status == 200)   {
            // Если мы попали сюда, следовательно был полученый корректный HTTP - ответ
            var response = req.responseText;         //HTTP-ответ в виде строки
            var lenders = JSON.parse(response);      //Преобразовать в JS-массив

            //Преобразовать массив объектов lender в HTML-строку
            var list ="";
            for (var i = 0; i < lenders.length; I++)  {
                list +="<li><a href='" + lenders[i].url + "'>" +
                    lenders[i].name + "</a>";
            }
            //Отобразить полученную HTML-строку в элементе,
            //Ссылка на который была получена выше.
            ad.innerHTML = "<ul>" + list + "</ul>";

        }
    }
}
</script>
    </body>
</html>